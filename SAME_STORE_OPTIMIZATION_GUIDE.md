# 同店舖RF轉出優化功能說明

## 📋 功能概述

新增的同店舖RF轉出優化功能旨在提高物流效率，通過智能算法將多個產品的轉出集中在同一店舖進行，減少跨店舖調貨的成本和複雜度。

## 🎯 優化目標

- **提高物流效率**：減少需要訪問的轉出店舖數量
- **降低調貨成本**：集中轉出降低運輸和人力成本  
- **簡化操作流程**：單店舖多品項操作更便於管理
- **保持業務邏輯**：不影響原有的優先級和匹配規則

## ⚙️ 算法邏輯

### 1. 分離處理策略
- **ND轉出**：保持最高優先級，優先處理
- **RF轉出**：採用同店舖優化策略

### 2. 店舖優先級計算
```
優先級 = (可轉出品項數量, 總轉出數量)
排序規則：品項數量多的店舖優先，品項數相同則按總數量排序
```

### 3. 匹配流程
1. 將RF轉出候選按店舖分組
2. 計算每個店舖的可轉出品項數和總數量
3. 按優先級排序店舖
4. 依序處理各店舖的轉出需求
5. 保持原有的數量優化邏輯（1件調高到2件）

## 📊 測試驗證結果

### 測試場景設計
- **A01店舖**：3個RF產品可轉出（多品項店舖）
- **B01店舖**：1個RF產品可轉出（單品項店舖）  
- **C01店舖**：3個產品需要接收（緊急缺貨）

### A模式（保守轉貨）結果
```
A01店舖：3個產品，總計25件 ✅ 多品項同店舖轉出
B01店舖：1個產品，總計6件
```

### B模式（加強轉貨）結果  
```
A01店舖：3個產品，總計52件 ✅ 多品項同店舖轉出
```

## 🔍 效果分析

### 優化前（理論情況）
- 可能分散在多個店舖進行轉出
- 需要訪問多個轉出地點
- 物流複雜度較高

### 優化後（實際結果）
- ✅ 成功將3個產品集中在A01店舖轉出
- ✅ 減少了需要訪問的店舖數量
- ✅ 提高了單次調貨的效率
- ✅ 保持了所有業務規則的完整性

## 💡 業務價值

1. **運輸成本降低**：減少跨店舖運輸次數
2. **人力效率提升**：集中處理減少人力調配
3. **庫存管理簡化**：集中轉出便於追蹤管理
4. **客戶體驗優化**：更快的調貨響應時間

## 🔧 技術實現

### 核心函數
- `_match_nd_transfers()`: 處理ND轉出
- `_match_rf_transfers_optimized()`: RF轉出優化邏輯
- `_create_suggestion()`: 建議記錄創建

### 數據結構優化
- 按店舖分組RF轉出候選
- 優先級計算和排序機制
- 保持原有匹配邏輯的完整性

---

*開發者：Ricky*  
*更新日期：2025-09-19*
